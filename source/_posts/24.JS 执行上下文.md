---
layout: post
title: JS执行上下文
category: js
tagline: "Supporting tagline"
tags: [js]
description: 执行上下文，即context，也不知道是谁翻译的，多数的文献、书籍用的都是这个词，还记得第一次接触这个词时的惆怅、迷惘、不知所措，扶了扶眼睛，翻开大辞典，还是翻译成环境比较接地气。JS执行上下文，即JS的执行环境。
date: 2017-4-03 18:10:20
---

### 执行上下文(Execution Context, EC)

当我们的代码执行时，会进入到不同的执行上下文，即不同的环境。在不同的环境中，有着不同的 scope(作用域)，代码所能访问到的资源也就不同。在 JS 中，执行上下文有如下三种情况:

- 全局环境
  代码默认运行的环境，代码执行时会首先进入全局环境。
- 函数环境
  函数被调用执行时，所创建的执行环境。
- eval
  不推荐使用，可忽略。

### 执行上下文栈(Execution Context Stack, ECS)

浏览器中的解释器被实现为单线程，同一时间只能处理一个任务，JS 程序中多个执行上下文会以栈的方式来处理，这个栈叫做执行栈。栈底永远都是全局上下文(窗口关闭时弹出)，栈顶就是当前正在执行的上下文。前述三种情况都会创建执行上下文，执行上下文创建时会被压入栈顶，位于栈顶的上下文执行完毕后就从栈顶弹出，并将上下文控制权交给当前的栈。

来看下面的例子:

```
var firstName = 'snow';

function getName() {
    var lastName = 'John';

    function fullName() {
      var name = lastName + firstName;
      return name;
    }
    var name = fullName();
    return name;
}

getName();
```

其执行栈变化过程如下图所示:

- 首先，将全局上下文压入栈，开始执行代码，
- 直到遇到`getName()`，准备调用函数，创建函数 getName 的执行上下文，将其压入栈顶并开始执行函数
- 直到遇到`fullName()`，准备调用函数，创建函数 fullName 的执行上下文，将其压入栈顶并开始执行函数
- 函数 fullName 执行时没有再生成执行上下文，执行完毕后则从栈顶弹出
- fullName 执行栈弹出后，控制权回到了 getName 的执行栈，继续执行代码，执行完毕，从栈顶弹出
- 最后回到了全局上下文，窗口关闭后弹出
  <img style="display:block; margin: auto;" alt="执行栈示意图" src="https://i.imgur.com/DLihUKi.png" />

### 结论

- 单线程，同步执行，只有栈顶的上下文处于执行中，其余上下文需要等待
- 执行 JS 程序，首先进入全局上下文，全局上下文只有一个并在关闭窗口时弹出
- 函数调用时会创建新的执行上下文，包括调用自己
