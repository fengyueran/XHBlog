---
layout: post
title: 关于首屏html限制14kb内的疑问
category: html
tagline: "Supporting tagline"
tags: [html]
description:
date: 2019-9-25 18:10:20
---

我们在调研优化网页加载性能时，通常能看到这样一条：html 最好限制在 14kb 以内。那么问题来了，为什么是 14kb，为什么我在测试的时候并没有体会到网络性能的改变，关于为什么是 14kb，从下面的概念开始。

### 相关概念

- cwnd(Congestion Window)

  即最拥塞窗口，慢启动中引入的概念，表示发送方在得到接收方确认前，最大允许传输的数据大小。

- MTU(Maximum Transmission Unit)

  即最大传输单元，是指一种通信协议的某一层上面所能通过的最大数据包大小(以字节为单位)。最大传输单元这个参数通常与通信接口有关(网络接口卡、串口等)。对于时下大多数以太网的局域网来说，最大 MTU 为 1500 字节。但是像 [PPPoE](https://zh.wikipedia.org/wiki/PPPoE) 这样的系统会减小这个数值，通常是 1492 = 1500 - 2(PPP) - 6(PPPoE)。

- MSS(Maximum Segment Size)

  即最大分段大小，是传输控制协议(TCP)的一个参数，以字节数定义一个计算机或通信设备所能接受的分段的最大数据量。 它并不会计算 TCP 或 IP 协议头的大小。
  一个 TCP 包(数据段)的荷载 <= MSS < MTU

  > PPPoE 首部 6，PPP 协议 2
  > 数据链路层最大 data 为 1500-8=1492
  > IPv4 首部最少 20，IPv6 首部 40，TCP 首部最少 20
  > MSS 最大为 1492-20-20=1452 字节

### 慢启动

在网络的实际传输过程中如果不加以控制，就很容易出现堵塞的现象，就像热门景区，如果不对车流进行控制，很快交通就会堵塞，最后瘫痪。因此 TCP 在设计时考虑到了这一点，会使用一些算法来避免网络拥塞、丢包等，主要包括：1）慢启动，2）拥塞避免，3）快速重传，4）快速恢复。

[慢启动](https://hpbn.co/building-blocks-of-tcp/#slow-start)是 Van Jacobson 在 1988 年提出的，其主要目的是用来防止宽带被迅速打满。其原理如下：

- 连接建好的开始先初始化 cwnd = 1，表明可以传一个 MSS 大小的数据。

- 每当收到一个 ACK，cwnd++; 呈线性上升

- 每当过了一个 RTT，cwnd = cwnd\*2; 呈指数让升

- 还有一个 ssthresh（slow start threshold），是一个上限，当 cwnd >= ssthresh 时，就会进入“拥塞避免算法”

 <center><img src="https://i.imgur.com/a7RnY4k.png" /></center>
 <center>cwnd</center>

由此，可以知道，由于慢启动的存在，网络传输的开始阶段并不能最大限度的利用宽带，而是一个动态调整的过程，在连接刚建好的第一个往返，做多只能传输 1MSS 大小的数据，如果超过这个大小(14kb)，数据包就会被拆分，必须等到第一个往返结束后再进行传送，增大了传输时间，因此首屏 html 应限制在 14kb 内。

### 14kb 限制的测试

前面提到资源超过 14kb 会多次往返，延长了传输时间，为了探究 html 刚好超过 14kb 时(多一次往返)对网页性能的影响，进行了如下测试：

1）测试环境
在[fast 3g](https://github.com/WPO-Foundation/webpagetest/blob/master/www/settings/connectivity.ini.sample)条件下进行测试，下行速度大概 204kb/s。

```
[3GFast]
 label="3G Fast (1.6 Mbps/768 Kbps 150ms RTT)"
 bwIn=1600000(下行bps)
 bwOut=768000(上行bps)
 latency=150(延迟)
 plr=0(丢包率)
 timeout=120
```

2）测试的方法
通过内联 css 对 html 大小进行动态调整，对比不同资源大小下的加载时间(load 时间)和首次内容绘制时间(FCP)，着重观察跨越 14kb 前后的时间差。
<img style="display:block; margin: auto;border: 1px solid；width:400px" src="https://i.imgur.com/xYznLy0.png" />

  <center>基础html</center>

3）测试结果

  <img style="display:block; margin: auto;border: 1px solid;width:400px" src="https://i.imgur.com/UktpBBq.png" />
  <center>FCP和Load时间随html体积变化测试结果</center>

可以看到 14kb 前后，FCP 和 Load 时间都没有太大变化，而 3g fast 下往返延时是 150ms，如果 html 超过 14kb 被分成两次传输，多一次往返，延时应该超过 150ms，load 时间最少应该增加 150ms，而测试结果并没有体现出来，感觉很慌。于是用 wireshark 抓包看看，是不是有分片传输。
<img style="display:block; margin: auto;border: 1px solid;" src="https://i.imgur.com/877Dazy.png" />

<center>html大小为14574字节时的抓包示意图</center>
可以看到html并没有被拆分发送而只在27帧进行发送，再看MSS，为16344字节，并不是前述的小于1500字节。我们知道1500字节这个MTU与网卡是有关系的，查看网卡信息，如下：
<img style="display:block; margin: auto;border: 1px solid;" src="https://i.imgur.com/msospq0.png" />
<center>网卡信息</center>

可以看到 mac 上我测试用的 lo0[回环网卡](https://zh.wikipedia.org/wiki/%E5%9B%9E%E7%8E%AF)的 mtu 为 16384，减去 ip 首部 20 和 tcp 首部 20，MSS 为 16344，也就是说 14574 字节的 html 并没有达到被拆包的大小阈值，没有对网页性能造成影响就说得过去，不慌了，不慌了。于是将 html 的大小增大至 16705(大于 16344)，再进行测试，结果仍未有太大影响，加载时间仍将在 650-660 间徘徊，黑人问号脸，再抓包看看：
<img style="display:block; margin: auto;border: 1px solid;" src="https://i.imgur.com/McR3iJb.png" />

<center>html大小为16705字节时的抓包示意图</center>

可以看到 html 被拆成了 19、20 两帧进行传输，确实是被拆分了，可结果仍不符合预期，用 chrome 的 performance、audit 多次进行测试，结果一样...
chrome 测试结果不准确？本地的 server 有问题？于是将测试 html 拷贝到远程服务器，用[webpagetest](https://www.webpagetest.org/)在 3g fast 条件下测试。
